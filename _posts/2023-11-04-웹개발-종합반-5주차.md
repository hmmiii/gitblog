---
title: 웹개발 종합반 5주차
author: hmmi
date: 2023-11-06 15:37
categories: [항해99,웹개발종합반]
tags: [항해99,웹개발종합반]
pin: true
toc: true
toc_sticky: true
---
멜로디쉐어 프로젝트에 DB 기능을 추가하고, 지금까지 만든 웹사이트를 Pythonanywhere의 무료 계정에 배포했다.
## 5주차 배운 내용

- Pythonanywhere로 배포하기
- 멜로디쉐어 프로젝트 DB 기능 추가


## 멜로디쉐어에 음악 추천 글 추가하기

멜로디쉐어 프로젝트에 음악 추천 글을 기존에는 웹 스크래핑을 이용해서 했다면, 이번에는 DB에 데이터를 추가하는 형식으로 구현해보았다.


### 템플릿 파일 수정

```html
<form action="{{ url_for('music_create') }}" method="GET">
  <div class="mb-3">
```

모달창의 form 태그의 action에 라우트 함수 명을 적고, method는 GET 으로 주었다.

```html
<form action="{{ url_for('music_create') }}" method="GET">
  <div class="mb-3">
    <label for="username-input" class="form-label">유저</label>
    <input type="text" class="form-control" id="username-input" name="username">
    <div id="usernamegHelp" class="form-text">등록하시는 사용자 이름을 넣어주세요.</div>
  </div>
	...
</form>
```

데이터를 담아서 보낼 input에는 name attr에 어떤 데이터인지 구분할 구분값을 넣어주었다. 이 구분값으로 flask에서 데이터를 받을 것이다.

### flask에서 데이터받기

[Flask API 만들기](https://hmmiii.github.io/posts/%EC%9B%B9%EA%B0%9C%EB%B0%9C-%EC%A2%85%ED%95%A9%EB%B0%98-3%EC%A3%BC%EC%B0%A8/#api-%EB%A7%8C%EB%93%A4%EA%B8%B0)에서 처럼, GET을 받을 API를 만들어주자.

```python
@app.route('/music/create')
def music_create():
    # form으로 데이터 입력 받기
    username_receive = request.args.get("username")
    title_receive = request.args.get("title")
    artist_receive = request.args.get("artist")
    image_receive = request.args.get("image_url")
```

### flask에서 db 추가하기

[flask-sqlalchemy](https://hmmiii.github.io/posts/%EC%9B%B9%EA%B0%9C%EB%B0%9C-%EC%A2%85%ED%95%A9%EB%B0%98-4%EC%A3%BC%EC%B0%A8/#flask-sqlalchemy)를 이용해서 DB를 받을 것이다.

```python
import os
from flask_sqlalchemy import SQLAlchemy

basedir = os.path.abspath(os.path.dirname(__file__))
app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] =\
        'sqlite:///' + os.path.join(basedir, 'database.db')

db = SQLAlchemy(app)

class Song(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String, nullable=False)
    artist = db.Column(db.String, nullable=False)
    title = db.Column(db.String, nullable=False)
    image_url = db.Column(db.String, nullable=False)

    def __repr__(self):
        return f'{self.artist} {self.title} 추천 by {self.username}'

with app.app_context():
    db.create_all()
```

Flask-SQLAlchemy 기본 코드와 테이블 생성 코드를 위쪽에 삽입하고,


```python
@app.route('/music/create')
def music_create():
    # form으로 데이터 입력 받기
    username_receive = request.args.get("username")
    title_receive = request.args.get("title")
    artist_receive = request.args.get("artist")
    image_receive = request.args.get("image_url")
    
	# 데이터를 DB에 저장하기
    song = Song(username=username_receive, title=title_receive, artist=artist_receive, image_url=image_receive)
    db.session.add(song)
    db.session.commit()
```

앞전의 코드에서 라우트 함수 안에서 받아온 데이터로 row를 추가하는 코드를 삽입한다.

### 입력 받은 후 리다이렉트

```python
from flask import redirect, url_for
```

flask 라이브러리의 redirect와 url_for를 임포트 해온 뒤, 입력한 이름으로 필터하는 라우트 함수로 리다이렉트 시키자.

```python
@app.route("/music/create/")
def music_create():
	...
    return redirect(url_for('render_music_filter', username=username_receive))
```

render_music_filter는 이렇게 생겼다.

```python
@app.route('/music/<username>/')
def render_music_filter(username):
    # 필터하기
    filter_list = Song.query.filter_by(username=username).all()
    return render_template('music.html', data=filter_list)
```

## 멜로디쉐어에 추가한 게시글 보여주기

이제 DB에 유저가 입력한 데이터를 추가했다. 기존 music 라우트 함수를 수정해보자.

```python
@app.route('/music/')
def music():
    # 전부 다 가져오기
    songs_list = Song.query.all()
    return render_template('music.html', data=songs_list)
```

간단하다. 보내줄 data를 Song 테이블의 데이터를 모두 가져와서 보내주면 된다. [테이블 전체 조회](https://hmmiii.github.io/posts/%EC%9B%B9%EA%B0%9C%EB%B0%9C-%EC%A2%85%ED%95%A9%EB%B0%98-4%EC%A3%BC%EC%B0%A8/#%ED%85%8C%EC%9D%B4%EB%B8%94-%EC%A0%84%EC%B2%B4-%EC%A1%B0%ED%9A%8C)참고.

템플릿은 이렇게 수정하자.


```html
<div id="card-list" class="row row-cols-1 row-cols-md-4 g-4 mx-auto w-75 pb-5">
      {% for song in data %}
      <div class="col">
        <div class="card h-100">
          <img src="{{ song.image_url }}" class="card-img-top" alt="...">
          <div class="card-body">
            <h5 class="card-title">{{ song.title }}</h5>
            <p class="card-text">{{ song.artist}}</p>
            <p class="card-text">추천 by {{ song.username }}</p>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    ...
```

### 추천인에 따른 음악 필터링해서 보여주기

[입력 받은 후 리다이렉트](#입력-받은-후-리다이렉트)에서 리다이렉트를 해준 이유가 있다. 유저네임에 따라 필터링해서 음악을 보여주기 위해서다.

```python
@app.route('/music/<username>/')
def render_music_filter(username):
    # 필터하기
    filter_list = Song.query.filter_by(username=username).all()
    return render_template('music.html', data=filter_list)
```

db에서 원하는 데이터만 골라서 가져오려면, 이렇게 수정한다.  [특정 조건으로 데이터 조회](https://hmmiii.github.io/posts/%EC%9B%B9%EA%B0%9C%EB%B0%9C-%EC%A2%85%ED%95%A9%EB%B0%98-4%EC%A3%BC%EC%B0%A8/#%ED%8A%B9%EC%A0%95-%EC%A1%B0%EA%B1%B4%EC%9C%BC%EB%A1%9C-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%A1%B0%ED%9A%8C) 참고.

여기까지 멜로디쉐어 페이지까지 작업이 완료되었다. 이제 멜로디쉐어 페이지는 데이터베이스가 적용되었다!

## 배포

배포는 클라우드 서비스를 이용해서 가능하다. AWS 등 여러 클라우드 서비스가 있지만, 파이썬 클라우드 서비스인 Pythonanywhere의 무료 계정으로 할 수 있다. Pythonanywhere은 국내 닷홈과 비슷한 느낌으로, 3개월 간 갱신을 안 해주면 만든 Webapp(가상 컴퓨터)가 삭제되는 구조이다.

[Pythonanywhere 바로가기](https://www.pythonanywhere.com/)

작업 순서는 이렇다.

1. 회원가입
2. Webapp 만들기
3. 코드 업로드 하기

회원가입은 패스하고, Webapp 만들기부터 알아보자.

### Webapp 만들기

- 대시보드 이동
- Web apps -\> Open Web tab 클릭
- Add a new web app
- Flask 선택 후 파이썬 버전 선택
- path 저장하기
- 이후 주소 확인 가능

### 코드 업로드 하기

- app.py 의 이름을 flask_app.py 로 변경
- 의존성 파일 생성
- .venv를 제외한 파일 압축
- pythonanywhere Web 탭에서 스크롤을 내려서 Source Code 칸에서 Go To directory 을 클릭
- Upload a file에서 프로젝트 폴더를 압축한 파일(예: project.zip)을 업로드
- 업로드가 잘 됐다면, Open Bash Console here 버튼을 클릭
- `ls` → 파일 확인 명령어로 파일을 확인
- `unzip “압축 파일 이름"` 명령어로 압축 해제
- `replace flask_app.py?` 라는 창이 나오면 `A`
- venv 가상환경 세팅
- 가상환경 활성화 합니다.
- `pip install -r requirements.txt`로 requirements.txt에 저장된 라이브러리를 설치
- 라이브러리 설치가 완료되었다면 Web 메뉴로 이동
- 스크롤을 내려서 Virtualenv
- Virtualenv 의 Enter Path to a virtualenv, if desired 클릭
- 복사해둔 Source code 경로 뒤에 venv를 붙여서 넣어줍니다. 예) Source Code 경로/venv 예) /home/codewithwoong/mysite/venv
- 이후 web -\> reload 버튼 누르면 배포 완료

이 순서대로 하면 되는데, 중간중간 추가 설명이 필요한 내용을 추가한다.

### 의존성 파일 생성

설치한 라이브러리들을 하나씩 설치하기 너무 번거롭기 때문에, 한번에 설치한 라이브러리의 버전을 정리한 텍스트 파일을 만들고 설치한다.

```bash
pip freeze > requirements.txt
```

### 가상환경 생성

파이썬 가상환경을 가상컴퓨터에도 추가해주는 것이다. [가상환경 생성](https://hmmiii.github.io/posts/%EC%9B%B9%EA%B0%9C%EB%B0%9C-%EC%A2%85%ED%95%A9%EB%B0%98-3%EC%A3%BC%EC%B0%A8/#%EA%B0%80%EC%83%81%ED%99%98%EA%B2%BD-%EC%83%9D%EC%84%B1%ED%95%98%EA%B8%B0) 참고.

이렇게 하면 web 탭에 있는 나의 주소로 확인이 가능하다.

## 마치며

이로써 웹개발 종합반의 1~5주차가 종료되었다. 5주차 숙제는 나름 빡센 편인데, 지금까지 배운 내용을 이용해서 나만의 웹사이트를 만들고 배포하기다. 내용이 길기 때문에, 추가 포스팅으로 남겨야겠다.

